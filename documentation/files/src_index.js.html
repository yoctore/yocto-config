<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/index.js - yocto-config</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../assets/css/logo.png" title="yocto-config" width="117" height="52"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.2.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Config.html">Config</a></li>
                            </ul>
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/index.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
&#x27;use strict&#x27;;

var path     = require(&#x27;path&#x27;);
var _        = require(&#x27;lodash&#x27;);
var logger   = require(&#x27;yocto-logger&#x27;);
var joi      = require(&#x27;joi&#x27;);
var fs       = require(&#x27;fs&#x27;);
var glob     = require(&#x27;glob&#x27;);
var util     = require(&#x27;util&#x27;);
   
/**
 * Yocto config controller. &lt;br/&gt;
 * Manage your configuration file (all / common / env  &amp; specific file)
 *
 * Config file has priority. And priority is defined like a php ini system.
 * (Other file).json &lt; all.json &lt; common.json &lt; development.json &lt; stagging.json &lt; production.json
 *
 * All specific data must be configured on a each correct file.
 * 
 * all.json : contains general data (speci
 al keys, app name, etc) =&gt; not env data
 * common.json : must containt all common data between each env
 * development.json : must contains development data for development environnement
 * staging.json : must contains stagging data for staging environnement
 * production.json : must contains production data for production environnement 
 *
 * For more details on these dependencies read links below :
 * - yocto-logger : lab.yocto.digital:yocto-node-modules/yocto-logger.git
 * - Lodash : https://lodash.com/
 * - path : https://nodejs.org/api/path.html
 * - joi : https://github.com/hapijs/joi
 * - fs : https://nodejs.org/api/fs.html
 * - glob : https://www.npmjs.com/package/glob
 * 
 * @date : 12/05/2015
 * @author : ROBERT Mathieu &lt;mathieu@yocto.re&gt;
 * @copyright : Yocto SAS, All right reserved
 * @class Config
 */
function Config() {
    /**
     * Default config value
     * 
     * @property config
     * @type {String}
     * @default {}
     */
    this.config = {};
    
    /**
     * Default state value, true if config state is or false otherwise
     */
    this.state  = false;
    /**
     * Default env value
     * 
     * @property env
     * @type {String}
     * @default development
     */
    this.env = &#x27;development&#x27;;
    
    /**
     * Default base path
     * 
     * @property base
     * @type string
     */
    this.base = path.normalize(process.cwd());
    
    /**
     * Default logger instance. can be override by set function
     * 
     * @property logger
     * @type Object
     */
    this.logger = logger;

    /**
     * Default schema validation for config validator
     * 
     * @property schema
     * @type Object
     */
    this.schema = joi.object().min(1).keys({
      app : joi.object().required().keys({
        name        : joi.string().required().empty().min(3),
        stackError  : joi.boolean().default(true),
        session     : joi.object().default({ timeout : 50000 }).keys({
          timeout : joi.number().default(500000)
        }).allow(&#x27;timeout&#x27;)        
      }).allow(&#x27;name&#x27;, &#x27;stackError&#x27;, &#x27;session&#x27;),
      express : joi.object().required().keys({
        jsonp       : joi.boolean().default(false),
        prettyHtml  : joi.boolean().default(true),
        viewEngine  : joi.string().empty().default(&#x27;jade&#x27;).allow(&#x27;jade&#x27;),
        filter      : joi.object().default({ rules : &#x27;json|text|javascript|css|html&#x27;, by : &#x27;Content-type&#x27;, level : 9 }).keys({
          rules : joi.string().default(&#x27;json|text|javascript|css|html&#x27;).empty(),
          by    : joi.string().default(&#x27;Content-Type&#x27;).allow(&#x27;Content-Type&#x27;), // for the moment only allow content type
          level : joi.number().default(9).min(0).max(9)
        }).allow(&#x27;rules&#x27;, &#x27;by&#x27;, &#x27;level&#x27;),
        json : joi.object().default({ inflate : true, limit : &#x27;100kb&#x27;, strict : true, type : &#x27;json&#x27; }).keys({
          inflate : joi.boolean().optional().default(true),
          limit   : joi.string().optional().empty().default(&#x27;100kb&#x27;),
          strict  : joi.boolean().optional().default(true),
          type    : joi.string().optional().empty().default(&#x27;json&#x27;).valid(&#x27;json&#x27;)
        }).allow(&#x27;inflate&#x27;, &#x27;limit&#x27;, &#x27;strict&#x27;, &#x27;type&#x27;),
        urlencoded : joi.object().default({ extended : true,  inflate : true, limit : &#x27;100kb&#x27;,  parameterLimit : 1000, type : &#x27;urlencoded&#x27; }).keys({
          extended        : joi.boolean().optional().default(true),
          inflate         : joi.boolean().optional().default(true),
          limit           : joi.string().optional().empty().default(&#x27;100kb&#x27;),
          parameterLimit  : joi.number().default(1000).min(1000),
          type    : joi.string().optional().empty().default(&#x27;urlencoded&#x27;).valid(&#x27;urlencoded&#x27;)          
        }).allow(&#x27;extended&#x27;, &#x27;inflate&#x27;, &#x27;limit&#x27;, &#x27;parameterLimit&#x27;, &#x27;type&#x27;, &#x27;verify&#x27;),
        methodOverride : joi.array().min(1).unique().default([ &#x27;_method&#x27; ]).items([
         joi.string().empty().default(&#x27;_method&#x27;).valid(&#x27;_method&#x27;, &#x27;X-HTTP-Method&#x27;, &#x27;X-HTTP-Method-Override&#x27;, &#x27;X-Method-Override&#x27;)
        ]),
        cookieParser  : joi.object().default({ enable : false, secret : &#x27;yocto-cookie-parser-secret-key&#x27;, options : {} }).keys({
          enable  : joi.boolean().default(true),
          secret  : joi.string().empty().default(&#x27;yocto-cookie-parser-secret-key&#x27;),
          options : joi.object().default({ path : &#x27;/&#x27;, expires : &#x27;Fri, 31 Dec 9999 23:59:59 GMT&#x27;, maxAge : 0, domain : null, secure : true, httpOnly : true }).keys({
            path      : joi.string().empty().optional().default(&#x27;/&#x27;),
            expires   : joi.string().empty().optional().default(&#x27;Fri, 31 Dec 9999 23:59:59 GMT&#x27;),
            maxAge    : joi.number().optional().default(0),
            domain    : joi.string().empty().optional().default(null),
            secure    : joi.boolean().optional().default(true),
            httpOnly  : joi.boolean().optional().default(false),          
          }).allow(&#x27;path&#x27;, &#x27;expires&#x27;, &#x27;maxAge&#x27;, &#x27;domain&#x27;, &#x27;secure&#x27;, &#x27;httpOnly&#x27;)
        }).allow(&#x27;enable&#x27;, &#x27;secret&#x27;, &#x27;options&#x27;),
        multipart     : joi.boolean().default(false),        
        session :  joi.object().default({ enable : false }).keys({
          enable : joi.boolean().default(true),
          options : joi.object().optional().keys({
            cookie : joi.object().default({ path : &#x27;/&#x27;, httpOnly : false, secure : true, maxAge : null }).keys({
              path      : joi.string().optional().default(&#x27;/&#x27;),
              httpOnly  : joi.boolean().optional().default(false),              
            	secure    : joi.boolean().optional().default(true),
              maxAge    : joi.number().optional().default(null)
            }).allow(&#x27;path&#x27;, &#x27;httpOnly&#x27;, &#x27;secure&#x27;, &#x27;maxAge&#x27;),
            secret            : joi.string().optional().min(8).default(&#x27;yocto-config-secret-key&#x27;),
            name              : joi.string().optional().min(5).default(&#x27;connect.sid&#x27;),
            genuuid           : joi.boolean().optional().default(false),            
            proxy             : joi.boolean().optional().default(undefined),
            resave            : joi.boolean().optional().default(false),
            saveUninitialized : joi.boolean().optional().default(true),
            rolling           : joi.boolean().optional().default(false),
          }).allow(&#x27;cookie&#x27;, &#x27;secret&#x27;, &#x27;name&#x27;, &#x27;genuuid&#x27;, &#x27;proxy&#x27;, &#x27;resave&#x27;, &#x27;saveUninitialized&#x27;, &#x27;rolling&#x27;)
        }).allow(&#x27;enable&#x27;, &#x27;options&#x27;),
        // TODO : if we need to integrate vhost, we must to complete these rules
        vhost : joi.object().optional().keys({
          enable : joi.boolean().required().default(false),
          options : joi.object().optional().keys({
            url     : joi.string().required().default(&#x27;/&#x27;),
            aliases : joi.array().items(
              joi.string().required().empty()
            ),
            subdomains : joi.boolean().required().default(false),
            http : joi.object().optional().keys({
              redirect : joi.object().required().keys({
                type     : joi.number(),
                url      : joi.string().required().empty(),
                port     : joi.number().required()
              }).allow(&#x27;type&#x27;, &#x27;url&#x27;, &#x27;port&#x27;)
            }).allow(&#x27;redirect&#x27;)
          }).allow(&#x27;url&#x27;, &#x27;aliases&#x27;, &#x27;subdomains&#x27;, &#x27;http&#x27;)
        }).allow(&#x27;enable&#x27;, &#x27;options&#x27;)
      }),
      env       : joi.string().default(&#x27;development&#x27;).empty().valid([ &#x27;development&#x27;, &#x27;staging&#x27;, &#x27;production&#x27; ]),
      port      : joi.number().default(3000),
      directory : joi.array().min(1).unique().default([ { models : &#x27;/&#x27; }, { controllers : &#x27;/&#x27; }, { views : &#x27;/&#x27; }, { public : &#x27;/&#x27; }, { icons : &#x27;/&#x27; } ]).items([
        joi.object().required().keys({ models       :  joi.string().empty().min(2).default(&#x27;/&#x27;) }),
        joi.object().required().keys({ controllers  :  joi.string().empty().min(2).default(&#x27;/&#x27;) }),
        joi.object().required().keys({ views        :  joi.string().empty().min(2).default(&#x27;/&#x27;) }),
        joi.object().required().keys({ public       :  joi.string().empty().min(2).default(&#x27;/&#x27;) }),
        joi.object().required().keys({ icons        :  joi.string().empty().min(2).default(&#x27;/&#x27;) }),
        joi.object().empty()
      ]),
      encrypt_key : joi.object().default({ key : &#x27;MyAppKey&#x27;, type : &#x27;hex&#x27; }).keys({
        key   : joi.string().default(&#x27;MyAppKey&#x27;).empty(),
        type  : joi.string().default(&#x27;hex&#x27;).valid([ &#x27;ascii&#x27;, &#x27;utf8&#x27;, &#x27;utf16le&#x27;, &#x27;ucs2&#x27;, &#x27;base64&#x27;, &#x27;binary&#x27;, &#x27;hex&#x27; ])
      })
    }).unknown(true);
}
    
/**
 * Default set function, a value to a specific params
 * 
 * @method set
 * @param {String} name current name to use
 * @param {String} value current value to assign on params name
 * @param {Boolean} value current value to assign on params name
 */
Config.prototype.set = function(name, value) {
  // check requirements
  if (!_.isUndefined(name) &amp;&amp; _.isString(name) &amp;&amp; !_.isEmpty(name)) {
    // need to normalize path ?
    if (name == &#x27;base&#x27;) {
      // is relative path ?
      if (value.charAt(0) == &#x27;.&#x27;) {
        // normalize
        value = path.normalize([ process.cwd(), value ].join(&#x27;/&#x27;));
      }
    }

    // assign value
    this[name] = value;  
  } else {
      this.logger.warning(&#x27;[ Core.set ] - Invalid value given. name must be a string and not empty. Operation aborted !&#x27;);
  }
  
  // retuning current instance
  return this;
};

/**
 * Return correct property from given name
 *
 * @method get 
 * @param {String} name the property name
 * @return {Mixed} needed data
 */
Config.prototype.get = function(name) {
  return this[name];
};

/**
 * Reload data
 *
* @method reload
 * @param {String} base if base exists and is valid reassign base and reload
 * @return {Boolean} true if load succeed false otherwise 
 */
Config.prototype.reload = function(base) {
  // check base before load for conditional assignation
  if (!_.isUndefined(base) &amp;&amp; !_.isNull(base) &amp;&amp; _.isString(base) &amp;&amp; !_.isEmpty(base)) {
    this.base = base;
  }
  
  // return load statement
  return this.load();
};

/**
 * Default load function, load data from all.js constant file
 *
 * @method load
 * @return {Boolean} return true if load is ok false otherwise
 */
Config.prototype.load = function() {
  
  // any errors ?? try/catch it 
  try {
    // default config object
    var config = {};
    
    // build pattern
    var pattern = path.normalize([ this.base,  &#x27;*.json&#x27; ].join(&#x27;/&#x27;));
    var penv    = path.normalize([ this.base,  [ this.env, &#x27;.json&#x27; ].join(&#x27;&#x27;) ].join(&#x27;/&#x27;));

    // get file (sync mode)
    var paths = glob.sync(pattern);
    
    // has a valid path ? no ? stop process 
    if (_.isEmpty(paths)) {
      throw &#x27;No path was found. operation aborted !&#x27;;
    }
    
    // sort path
    paths = _.sortBy(paths, function(p) {
      var all         = path.normalize([ this.base, &#x27;all.json&#x27; ].join(&#x27;/&#x27;));
      var common      = path.normalize([ this.base, &#x27;common.json&#x27; ].join(&#x27;/&#x27;));
      var development = path.normalize([ this.base, &#x27;development.json&#x27; ].join(&#x27;/&#x27;));
      var staging     = path.normalize([ this.base, &#x27;staging.json&#x27; ].join(&#x27;/&#x27;));
      var production  = path.normalize([ this.base, &#x27;production.json&#x27; ].join(&#x27;/&#x27;));
      
      // return data order
      return [ p == production, p == staging,  p == development, p == common, p == all, p == p ].join(&#x27;|&#x27;);                         
    }, this);
    
    // parse all and merge if no error
    _.each(paths, function(path) {
      var item = JSON.parse(fs.readFileSync(path, &#x27;utf-8&#x27;));

      // merge data
      _.merge(config, item);

      // has current env ? if test return false stop env was founded
      return penv != path;
    });
    
    // validate !!!
    var result = joi.validate(config, this.get(&#x27;schema&#x27;), { abortEarly : false });
    
    // has error
    if (!_.isNull(result.error)) {
      // parse details
      _.each(result.error.details, function(error) {
        this.logger.warning([ &#x27;[ Config.load ] - Cannot update config an error occured. Error is :&#x27;, util.inspect(error, { depth : null }) ].join(&#x27; &#x27;));
      }, this);
      
      // throw exception error occured
      throw &#x27;Config validation failed&#x27;;
    }
    
    // build directory value to UPPERCASE constants
    _.each(config.directory, function(dir) {
      // build path
      var p = _.first(_.values(dir));

      // is relative path ?
      if (p.charAt(0) == &#x27;.&#x27;) {
        p = path.normalize([ process.cwd(), p ].join(&#x27;/&#x27;));              
      }

      // build key            
      var k = [ _.first(_.keys(dir)), &#x27;directory&#x27; ].join(&#x27;_&#x27;).toUpperCase();
      
      // assign
      this[k] = p;
    }, this);
    
    // change state
    this.state = true;

    // valid so assign config
    this.config = result.value;
    this.logger.info([ &#x27;[ Config.load ] - Success - Config file was changed with files based on :&#x27;, this.base ].join(&#x27; &#x27;));
  } catch (e) {
      this.logger.error([ &#x27;[ Config.load ] - an error occured during load config file. Error is :&#x27;, e ].join(&#x27; &#x27;));
      // return false otherwise
      return false;
  }

  // return true if all is ok
  return true;
};

/**
 * Export the ConfController
 */
module.exports = new (Config)();

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
